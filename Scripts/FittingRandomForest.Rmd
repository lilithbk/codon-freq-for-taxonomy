---
title: "Fitting Random Forest"
output: html_document
---

## Load Data

```{r, load-data}
df <- read.csv("Data/consolidated_codons.csv")
df$Kingdom <- as.factor(df$Kingdom)
# Split into training and testing sets
set.seed(27)
testid <- sample(1:nrow(df), nrow(df) * 0.3)
df.test <- df[testid, ]
df.train <- df[-testid, ]
```

## Tune Random Forest Hyperparameters

```{r, define-RF-func}
library(randomForest)
library(caret)

tune_rf_codons <- function(mtry = 8, ntree = 500){
  # Initialize matrix to store macro F1 scores and mean balanced accuracy
  rf_f1 <- matrix(nrow = length(mtry), ncol = length(ntree))
  rf_bal_acc <- matrix(nrow = length(mtry), ncol = length(ntree))
  
  # Iterate through all mtry and ntree values
  for (i in 1:length(mtry)){
    for (j in 1:length(ntree)){
      # Fit random forest model
      rf_fit <- randomForest(Kingdom ~ ., data = df.train, mtry = mtry[i], ntree = ntree[j])
      # Make predictions on test data
      rf_pred <- predict(rf_fit, newdata = df.test)
      # caret's confusionMatrix function automatically calculates F1 scores
      cm <- confusionMatrix(rf_pred, df.test$Kingdom)
      # Calculate macro F1 score from per-class F1 scores
      rf_f1[i, j] <- mean(cm$byClass[, "F1"])
      # Calculate mean balanced accuracy
      rf_bal_acc[i, j] <- mean(cm$byClass[, "Balanced Accuracy"])
    }
  }
  rownames(rf_f1) <- mtry
  rownames(rf_bal_acc) <- mtry
  colnames(rf_f1) <- ntree  
  colnames(rf_bal_acc) <- ntree  
  return(list(rf_f1, rf_bal_acc))
}
```

```{r, RF-tuning}
# Tune number of variables at each split and number of trees
rf_tuned <- tune_rf_codons(mtry = seq(6, 10), ntree = seq(250, 1000, 250))
which.max(rf_tuned[[1]])
which.max(rf_tuned[[2]])
rf_tuned
# Save list of matrices to avoid re-doing computationally expensive tuning
saveRDS(rf_tuned, "Fits/RFHyperparams.rds")
```


## Fit Final Random Forest Model

Based on both macro F1 score and mean balanced accuracy, the highest performing combination of hyperparameters was `mtry = 10` and `ntrees = 750`. 

```{r, final-RF}
set.seed(27)
rf_fit <- randomForest(Kingdom ~ ., df.train, ntree = 750, mtry = 10, importance = TRUE, strata = df.train$Kingdom)
saveRDS(rf_fit, "Fits/RandomForestFinalModel.rds")
```

